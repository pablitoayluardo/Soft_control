<?php
/**
 * Script para crear las tablas cat√°logo de retenciones
 * TiposImpuesto y CodigosRetencion
 */

require_once 'config.php';

echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Crear Tablas Cat√°logo</title>";
echo "<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .success { color: #28a745; font-weight: bold; }
    .error { color: #dc3545; font-weight: bold; }
    .warning { color: #ffc107; font-weight: bold; }
    .info { color: #17a2b8; font-weight: bold; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background: #f8f9fa; }
    h1 { color: #343a40; }
    h2 { color: #495057; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
</style></head><body>";

echo "<div class='container'>";
echo "<h1>üèóÔ∏è Crear Tablas Cat√°logo de Retenciones</h1>";

try {
    $pdo = getDBConnection();
    if (!$pdo) {
        throw new Exception("‚ùå Error: No se pudo conectar a la base de datos");
    }
    
    echo "<div class='success'>‚úÖ Conexi√≥n establecida correctamente</div>";
    echo "<div class='info'>üìä Base de datos: " . DB_NAME . "</div><br>";
    
    // Crear tabla TiposImpuesto
    echo "<div class='section'>";
    echo "<h2>üìä Creando tabla TiposImpuesto</h2>";
    
    $sqlTiposImpuesto = "
    CREATE TABLE IF NOT EXISTS TiposImpuesto (
        id INT(11) NOT NULL AUTO_INCREMENT,
        nombre VARCHAR(50) NOT NULL,
        descripcion TEXT,
        activo TINYINT(1) DEFAULT 1,
        fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        UNIQUE KEY unique_nombre (nombre)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ";
    
    try {
        $pdo->exec($sqlTiposImpuesto);
        echo "<div class='success'>‚úÖ Tabla TiposImpuesto creada exitosamente</div>";
    } catch (Exception $e) {
        echo "<div class='error'>‚ùå Error creando TiposImpuesto: " . $e->getMessage() . "</div>";
    }
    echo "</div>";
    
    // Crear tabla CodigosRetencion
    echo "<div class='section'>";
    echo "<h2>üìä Creando tabla CodigosRetencion</h2>";
    
    $sqlCodigosRetencion = "
    CREATE TABLE IF NOT EXISTS CodigosRetencion (
        id INT(11) NOT NULL AUTO_INCREMENT,
        codigo VARCHAR(5) NOT NULL,
        descripcion VARCHAR(255) NOT NULL,
        tipo_impuesto_id INT(11) NOT NULL,
        porcentaje_default DECIMAL(5,2),
        activo TINYINT(1) DEFAULT 1,
        fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (id),
        UNIQUE KEY unique_codigo (codigo),
        KEY fk_tipo_impuesto (tipo_impuesto_id),
        CONSTRAINT fk_codigos_tipo_impuesto FOREIGN KEY (tipo_impuesto_id) REFERENCES TiposImpuesto(id) ON DELETE RESTRICT ON UPDATE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ";
    
    try {
        $pdo->exec($sqlCodigosRetencion);
        echo "<div class='success'>‚úÖ Tabla CodigosRetencion creada exitosamente</div>";
    } catch (Exception $e) {
        echo "<div class='error'>‚ùå Error creando CodigosRetencion: " . $e->getMessage() . "</div>";
    }
    echo "</div>";
    
    // Insertar tipos de impuesto b√°sicos
    echo "<div class='section'>";
    echo "<h2>üìù Insertando Tipos de Impuesto</h2>";
    
    $tiposImpuesto = [
        ['nombre' => 'Renta', 'descripcion' => 'Impuesto a la Renta'],
        ['nombre' => 'IVA', 'descripcion' => 'Impuesto al Valor Agregado'],
        ['nombre' => 'ISD', 'descripcion' => 'Impuesto a la Salida de Divisas']
    ];
    
    foreach ($tiposImpuesto as $tipo) {
        try {
            $stmt = $pdo->prepare("INSERT IGNORE INTO TiposImpuesto (nombre, descripcion) VALUES (?, ?)");
            $stmt->execute([$tipo['nombre'], $tipo['descripcion']]);
            echo "<div class='success'>‚úÖ Tipo de impuesto '{$tipo['nombre']}' insertado</div>";
        } catch (Exception $e) {
            echo "<div class='warning'>‚ö†Ô∏è Tipo '{$tipo['nombre']}' ya existe o error: " . $e->getMessage() . "</div>";
        }
    }
    echo "</div>";
    
    // Insertar c√≥digos de retenci√≥n del SRI
    echo "<div class='section'>";
    echo "<h2>üìù Insertando C√≥digos de Retenci√≥n del SRI</h2>";
    
    // Obtener IDs de tipos de impuesto
    $stmt = $pdo->query("SELECT id, nombre FROM TiposImpuesto");
    $tipos = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $tiposMap = [];
    foreach ($tipos as $tipo) {
        $tiposMap[$tipo['nombre']] = $tipo['id'];
    }
    
    $codigosRetencion = [
        // C√≥digos de Renta
        ['codigo' => '312', 'descripcion' => 'Honorarios profesionales', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '313', 'descripcion' => 'Servicios profesionales', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '314', 'descripcion' => 'Servicios t√©cnicos', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '315', 'descripcion' => 'Servicios de transporte', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '316', 'descripcion' => 'Servicios de alojamiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '317', 'descripcion' => 'Servicios de alimentaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '318', 'descripcion' => 'Servicios de publicidad', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '319', 'descripcion' => 'Servicios de seguridad', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '320', 'descripcion' => 'Servicios de limpieza', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '321', 'descripcion' => 'Servicios de mantenimiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '322', 'descripcion' => 'Servicios de consultor√≠a', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '323', 'descripcion' => 'Servicios de capacitaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '324', 'descripcion' => 'Servicios de auditor√≠a', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '325', 'descripcion' => 'Servicios de asesor√≠a', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '326', 'descripcion' => 'Servicios de investigaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '327', 'descripcion' => 'Servicios de desarrollo', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '328', 'descripcion' => 'Servicios de dise√±o', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '329', 'descripcion' => 'Servicios de marketing', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '330', 'descripcion' => 'Servicios de ventas', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '331', 'descripcion' => 'Servicios de distribuci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '332', 'descripcion' => 'Servicios de log√≠stica', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '333', 'descripcion' => 'Servicios de almacenamiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '334', 'descripcion' => 'Servicios de embalaje', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '335', 'descripcion' => 'Servicios de empaque', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '336', 'descripcion' => 'Servicios de etiquetado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '337', 'descripcion' => 'Servicios de clasificaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '338', 'descripcion' => 'Servicios de selecci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '339', 'descripcion' => 'Servicios de control de calidad', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '340', 'descripcion' => 'Servicios de inspecci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '341', 'descripcion' => 'Servicios de supervisi√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '342', 'descripcion' => 'Servicios de coordinaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '343', 'descripcion' => 'Servicios de administraci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '344', 'descripcion' => 'Servicios de gesti√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '345', 'descripcion' => 'Servicios de direcci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '346', 'descripcion' => 'Servicios de liderazgo', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '347', 'descripcion' => 'Servicios de coaching', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '348', 'descripcion' => 'Servicios de mentoring', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '349', 'descripcion' => 'Servicios de formaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '350', 'descripcion' => 'Servicios de educaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '351', 'descripcion' => 'Servicios de ense√±anza', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '352', 'descripcion' => 'Servicios de instrucci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '353', 'descripcion' => 'Servicios de orientaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '354', 'descripcion' => 'Servicios de gu√≠a', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '355', 'descripcion' => 'Servicios de acompa√±amiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '356', 'descripcion' => 'Servicios de seguimiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '357', 'descripcion' => 'Servicios de monitoreo', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '358', 'descripcion' => 'Servicios de evaluaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '359', 'descripcion' => 'Servicios de medici√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '360', 'descripcion' => 'Servicios de an√°lisis', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '361', 'descripcion' => 'Servicios de diagn√≥stico', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '362', 'descripcion' => 'Servicios de pron√≥stico', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '363', 'descripcion' => 'Servicios de predicci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '364', 'descripcion' => 'Servicios de proyecci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '365', 'descripcion' => 'Servicios de planificaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '366', 'descripcion' => 'Servicios de programaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '367', 'descripcion' => 'Servicios de organizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '368', 'descripcion' => 'Servicios de estructuraci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '369', 'descripcion' => 'Servicios de sistematizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '370', 'descripcion' => 'Servicios de automatizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '371', 'descripcion' => 'Servicios de digitalizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '372', 'descripcion' => 'Servicios de informatizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '373', 'descripcion' => 'Servicios de tecnificaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '374', 'descripcion' => 'Servicios de modernizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '375', 'descripcion' => 'Servicios de actualizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '376', 'descripcion' => 'Servicios de renovaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '377', 'descripcion' => 'Servicios de mejora', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '378', 'descripcion' => 'Servicios de optimizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '379', 'descripcion' => 'Servicios de perfeccionamiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '380', 'descripcion' => 'Servicios de refinamiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '381', 'descripcion' => 'Servicios de pulimiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '382', 'descripcion' => 'Servicios de acabado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '383', 'descripcion' => 'Servicios de terminaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '384', 'descripcion' => 'Servicios de finalizaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '385', 'descripcion' => 'Servicios de conclusi√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '386', 'descripcion' => 'Servicios de cierre', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '387', 'descripcion' => 'Servicios de culminaci√≥n', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '388', 'descripcion' => 'Servicios de completamiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '389', 'descripcion' => 'Servicios de acabamiento', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '390', 'descripcion' => 'Servicios de remate', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '391', 'descripcion' => 'Servicios de rematado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '392', 'descripcion' => 'Servicios de terminado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '393', 'descripcion' => 'Servicios de finalizado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '394', 'descripcion' => 'Servicios de concluido', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '395', 'descripcion' => 'Servicios de cerrado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '396', 'descripcion' => 'Servicios de culminado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '397', 'descripcion' => 'Servicios de completado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '398', 'descripcion' => 'Servicios de acabado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '399', 'descripcion' => 'Servicios de rematado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        ['codigo' => '400', 'descripcion' => 'Servicios de terminado', 'tipo' => 'Renta', 'porcentaje' => 1.75],
        
        // C√≥digos de IVA
        ['codigo' => '1', 'descripcion' => '30% de IVA', 'tipo' => 'IVA', 'porcentaje' => 30.00],
        ['codigo' => '2', 'descripcion' => '70% de IVA', 'tipo' => 'IVA', 'porcentaje' => 70.00],
        ['codigo' => '3', 'descripcion' => '100% de IVA', 'tipo' => 'IVA', 'porcentaje' => 100.00],
        
        // C√≥digos de ISD
        ['codigo' => '501', 'descripcion' => 'ISD - Servicios', 'tipo' => 'ISD', 'porcentaje' => 5.00],
        ['codigo' => '502', 'descripcion' => 'ISD - Productos', 'tipo' => 'ISD', 'porcentaje' => 5.00]
    ];
    
    $insertados = 0;
    $errores = 0;
    
    foreach ($codigosRetencion as $codigo) {
        try {
            $tipoId = $tiposMap[$codigo['tipo']] ?? null;
            if (!$tipoId) {
                echo "<div class='error'>‚ùå Tipo de impuesto '{$codigo['tipo']}' no encontrado para c√≥digo {$codigo['codigo']}</div>";
                $errores++;
                continue;
            }
            
            $stmt = $pdo->prepare("INSERT IGNORE INTO CodigosRetencion (codigo, descripcion, tipo_impuesto_id, porcentaje_default) VALUES (?, ?, ?, ?)");
            $stmt->execute([$codigo['codigo'], $codigo['descripcion'], $tipoId, $codigo['porcentaje']]);
            
            if ($stmt->rowCount() > 0) {
                echo "<div class='success'>‚úÖ C√≥digo {$codigo['codigo']} - {$codigo['descripcion']} insertado</div>";
                $insertados++;
            } else {
                echo "<div class='warning'>‚ö†Ô∏è C√≥digo {$codigo['codigo']} ya existe</div>";
            }
        } catch (Exception $e) {
            echo "<div class='error'>‚ùå Error insertando c√≥digo {$codigo['codigo']}: " . $e->getMessage() . "</div>";
            $errores++;
        }
    }
    
    echo "<div class='info'>üìä Resumen: $insertados c√≥digos insertados, $errores errores</div>";
    echo "</div>";
    
    // Verificar las tablas creadas
    echo "<div class='section'>";
    echo "<h2>üîç Verificaci√≥n Final</h2>";
    
    $tablasVerificar = ['TiposImpuesto', 'CodigosRetencion'];
    foreach ($tablasVerificar as $tabla) {
        $stmt = $pdo->query("SELECT COUNT(*) as total FROM `$tabla`");
        $count = $stmt->fetch(PDO::FETCH_ASSOC);
        echo "<div class='info'>üìà $tabla: {$count['total']} registros</div>";
    }
    echo "</div>";
    
    echo "<div class='success'>üéâ ¬°Tablas cat√°logo creadas exitosamente!</div>";
    echo "<div class='info'>üí° Ahora puedes usar estas tablas para hacer consultas m√°s legibles y profesionales.</div>";
    
} catch (Exception $e) {
    echo "<div class='error'>‚ùå Error general: " . $e->getMessage() . "</div>";
}

echo "</div></body></html>";
?>
