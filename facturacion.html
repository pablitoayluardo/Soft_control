<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturaci√≥n - Sistema de Control GloboCity</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        /* Estilos base para evitar scroll innecesario */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .facturacion-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            margin: 0;
            padding: 12px; /* Reducido de 15px a 12px */
            box-sizing: border-box;
        }
        
        .top-navigation {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-filter);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 8px 12px; /* Reducido de 12px 15px a 8px 12px */
            margin-bottom: 10px; /* Reducido de 15px a 10px */
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .nav-buttons {
            display: flex;
            gap: 6px; /* Reducido de 8px a 6px */
            flex-wrap: wrap;
        }
        
        .nav-button {
            display: flex;
            align-items: center;
            padding: 6px 10px; /* Reducido de 8px 12px a 6px 10px */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .nav-button:hover {
            background: rgba(74, 222, 128, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .nav-button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .nav-button i {
            margin-right: 4px; /* Reducido de 6px a 4px */
            font-size: 14px;
        }
        
        .back-button {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 6px 10px; /* Reducido de 8px 12px a 6px 10px */
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px; /* Reducido de 6px a 4px */
        }
        
        .back-button:hover {
            background: rgba(74, 222, 128, 0.1);
            transform: translateX(-5px);
        }
        
        .content-area {
            flex: 1;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-filter);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 12px; /* Reducido de 15px a 12px */
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .content-area::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            opacity: 0.1;
            border-radius: 50%;
            z-index: -1;
        }
        
        .content-section {
            display: none;
            flex: 1;
            overflow: visible;
            padding: 0; /* Sobrescribir el padding de 24px del CSS externo */
            min-height: 0;
            height: auto;
        }
        
        .content-section.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Estilo espec√≠fico para la secci√≥n de subida de facturas - MISMAS DIMENSIONES QUE DIVISI√ìN 1 + T√çTULO */
        .upload-section {
            padding-left: 0 !important;
            padding-right: 0 !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            /* Aplicar dimensiones similares a .top-navigation pero con m√°s altura */
            background: var(--glass-bg) !important;
            backdrop-filter: var(--backdrop-filter) !important;
            border: 1px solid var(--glass-border) !important;
            border-radius: var(--border-radius-lg) !important;
            margin-bottom: 10px !important; /* Exactamente igual que .top-navigation */
            box-shadow: var(--shadow-lg) !important;
            display: flex !important;
            flex-direction: column !important; /* Cambiar a columna para incluir t√≠tulo */
            flex-shrink: 0 !important;
            /* Altura aumentada para incluir t√≠tulo */
            height: 100px !important;
            min-height: 100px !important;
            max-height: 100px !important;
        }
        
        .upload-section .table-content {
            padding: 4px 12px !important; /* Padding para el contenido */
            min-height: auto !important;
            max-height: none !important;
            height: auto !important;
            display: flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            flex: 1 !important; /* Tomar el espacio restante */
        }
        
        /* Controles de subida optimizados para menor altura - MISMAS DIMENSIONES QUE DIVISI√ìN 1 */
        .upload-controls {
            display: flex !important;
            align-items: center !important;
            gap: 6px !important; /* Exactamente igual que .nav-buttons */
            margin-bottom: 0 !important; /* Sin margen inferior */
            flex-wrap: wrap !important;
            justify-content: flex-start !important;
            margin-left: 0 !important;
            padding-left: 0 !important;
            padding: 0 !important; /* Sin padding */
            height: 100% !important;
        }
        
        .upload-controls label {
            display: flex !important;
            align-items: center !important;
            gap: 4px !important; /* Exactamente igual que .nav-button i */
            font-weight: 600 !important;
            margin: 0 !important;
            padding: 0 !important;
            font-size: 13px !important; /* Exactamente igual que .nav-button */
        }
        
        .upload-controls input[type="text"] {
            flex: 1 !important;
            min-width: 200px !important;
            padding: 6px 10px !important; /* Exactamente igual que .nav-button */
            border: 1px solid var(--glass-border) !important;
            border-radius: var(--border-radius) !important;
            background: var(--glass-bg) !important;
        }
        
        .upload-controls input[type="checkbox"] {
            width: 14px !important;
            height: 14px !important;
        }
        
        /* Restaurar header de la secci√≥n de subida con altura reducida */
        .upload-section .table-header {
            display: block !important; /* Mostrar el header */
            padding: 2px 8px !important; /* Padding reducido */
            background: rgba(74, 222, 128, 0.1) !important;
            border-bottom: 1px solid var(--glass-border) !important;
            flex-shrink: 0 !important;
        }
        
        .upload-section .table-header h3 {
            display: block !important;
            font-size: 0.85rem !important; /* Tama√±o reducido */
            margin: 0 !important;
            color: var(--text-primary) !important;
        }
        
        /* Reducir margen del resultado de subida */
        #resultado-subida {
            margin-top: 0 !important;
            display: block !important; /* Mostrar para mantener funcionalidad */
        }
        
        .content-header {
            margin-bottom: 2px; /* Reducido de 4px a 2px */
            text-align: center;
            flex-shrink: 0;
        }
        
        .content-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1px; /* Reducido de 2px a 1px */
        }
        
        .content-header p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0; /* Eliminar margen por defecto */
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 6px; /* Reducido de 8px a 6px */
            margin-bottom: 6px; /* Reducido de 8px a 6px */
            flex-shrink: 0;
        }
        
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 6px; /* Reducido de 8px a 6px */
            text-align: center;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card .stat-icon {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-bottom: 2px; /* Reducido de 4px a 2px */
        }
        
        .stat-card .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1px; /* Reducido de 2px a 1px */
        }
        
        .stat-card .stat-label {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin: 0; /* Eliminar margen por defecto */
        }
        
        .table-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            overflow: visible;
            margin-top: 2px; /* Reducido de 3px a 2px */
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .table-header {
            background: rgba(74, 222, 128, 0.1);
            padding: 4px 10px; /* Reducido de 6px a 4px */
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        
        .table-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .table-content {
            padding: 4px; /* Reducido de 6px a 4px */
            overflow: auto;
            flex: 1;
            min-height: 0;
            width: 100%;
            max-height: 600px; /* Altura m√°xima para el scroll */
            position: relative; /* A√±adir posici√≥n relativa */
        }
        
        .loading {
            text-align: center;
            padding: 10px; /* Reducido de 15px a 10px */
            color: var(--text-secondary);
        }
        
        .loading i {
            font-size: 1.1rem;
            margin-bottom: 4px; /* Reducido de 6px a 4px */
            color: var(--primary-color);
        }
        
        /* Estilos para la tabla responsiva */
        .facturas-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
            position: relative;
            margin: 0; /* Remover margen para que el encabezado sticky se posicione correctamente */
        }
        
        .facturas-table thead {
            position: sticky;
            top: -4px; /* Ajustado de -6px a -4px para compensar el nuevo padding */
            z-index: 100;
            background: #007bff;
        }
        
        .facturas-table th {
            background: #007bff;
            color: white;
            padding: 8px 4px; /* Reducido de 10px 6px a 8px 4px */
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: -4px; /* Ajustado de -6px a -4px para compensar el nuevo padding */
            z-index: 100;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
                 .facturas-table td {
             padding: 6px 4px; /* Reducido de 8px 6px a 6px 4px */
             border: 1px solid #ddd;
             vertical-align: top;
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap;
         }
         
         /* Permitir que los estatus se muestren completos */
         .facturas-table td:nth-child(8) {
             overflow: visible;
             white-space: nowrap;
             word-wrap: normal;
             text-align: center;
         }
        
        .facturas-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .facturas-table tr:hover {
            background: #e3f2fd;
        }
        
        /* Estilos para mejorar la experiencia de scroll */
        .table-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
                 /* Ajustar anchos de columnas espec√≠ficas */
         .facturas-table th:nth-child(1), .facturas-table td:nth-child(1) { width: 5%; } /* ESTAB */
         .facturas-table th:nth-child(2), .facturas-table td:nth-child(2) { width: 5%; } /* PTO EMI */
         .facturas-table th:nth-child(3), .facturas-table td:nth-child(3) { width: 7%; } /* SECUENCIAL */
         .facturas-table th:nth-child(4), .facturas-table td:nth-child(4) { width: 9%; } /* FECHA EMISI√ìN */
         .facturas-table th:nth-child(5), .facturas-table td:nth-child(5) { width: 17%; } /* CLIENTE */
         .facturas-table th:nth-child(6), .facturas-table td:nth-child(6) { width: 17%; } /* DIRECCI√ìN */
         .facturas-table th:nth-child(7), .facturas-table td:nth-child(7) { width: 7%; } /* TOTAL */
         .facturas-table th:nth-child(8), .facturas-table td:nth-child(8) { width: 12%; } /* ESTATUS */
         .facturas-table th:nth-child(9), .facturas-table td:nth-child(9) { width: 7%; } /* RETENCI√ìN */
         .facturas-table th:nth-child(10), .facturas-table td:nth-child(10) { width: 7%; } /* VALOR PAGADO */
         .facturas-table th:nth-child(11), .facturas-table td:nth-child(11) { width: 9%; } /* ACCIONES */
        
        .file-input-hidden {
            display: none;
        }
        
        /* Estilos para paginaci√≥n */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px; /* Reducido de 10px a 8px */
            padding: 8px 12px; /* Reducido de 10px 15px a 8px 12px */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            flex-shrink: 0;
        }
        
        .pagination-info {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 6px; /* Reducido de 8px a 6px */
        }
        
        .pagination-btn {
            padding: 4px 8px; /* Reducido de 6px 10px a 4px 8px */
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            background: var(--glass-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 3px; /* Reducido de 4px a 3px */
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: rgba(74, 222, 128, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-numbers {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .page-number {
            padding: 4px 8px; /* Reducido de 6px 10px a 4px 8px */
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            background: var(--glass-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            min-width: 32px; /* Reducido de 35px a 32px */
            text-align: center;
            font-size: 12px;
        }
        
        .page-number:hover:not(.active) {
            background: rgba(74, 222, 128, 0.1);
            border-color: var(--primary-color);
        }
        
        .page-number.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Estilos para headers ordenables */
        .sortable-header {
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }
        
        .sortable-header:hover {
            background: rgba(74, 222, 128, 0.1);
        }
        
        .sortable-header.sort-asc::after {
            content: ' ‚ñ≤';
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .sortable-header.sort-desc::after {
            content: ' ‚ñº';
            color: var(--primary-color);
            font-weight: bold;
        }
        
        /* Estilos para headers filtrables */
        .filterable-header {
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }
        
        .filterable-header:hover {
            background: rgba(74, 222, 128, 0.1);
        }
        
        .filterable-header.filter-active {
            background: rgba(74, 222, 128, 0.2);
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .filterable-header.filter-active::after {
            content: ' üîç';
            color: var(--primary-color);
            font-weight: bold;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .facturacion-container {
                padding: 15px;
            }
            
            .content-area {
                padding: 15px;
            }
            
            .facturas-table {
                font-size: 11px;
            }
            
            .facturas-table th,
            .facturas-table td {
                padding: 6px 4px;
            }
        }
        
        @media (max-width: 768px) {
            .facturacion-container {
                padding: 10px;
                height: 100vh;
            }
            
            .top-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 5px;
                width: 100%;
            }
            
            .nav-button {
                font-size: 12px;
                padding: 8px 12px;
                justify-content: center;
            }
            
            .content-header h1 {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .page-numbers {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .facturas-table {
                font-size: 10px;
            }
            
            .table-content {
                max-height: 400px; /* Altura reducida para m√≥viles */
            }
            
            .facturas-table th {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .facturas-table td {
                padding: 6px 4px;
                font-size: 10px;
            }
        }
        
                 /* Estilos para diferentes estatus - Colores distintivos */
        .status-registered {
            background: #e3f2fd !important;
            color: #1565c0 !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-size: 11px !important;
            font-weight: bold !important;
            border: 1px solid #bbdefb !important;
            display: inline-block !important;
            white-space: nowrap !important;
            word-break: keep-all !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            width: auto !important;
            min-width: fit-content !important;
            box-sizing: border-box !important;
        }
        
        .status-pending {
            background: #fff8e1 !important;
            color: #f57c00 !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-size: 11px !important;
            font-weight: bold !important;
            border: 1px solid #ffecb3 !important;
            display: inline-block !important;
            white-space: nowrap !important;
            word-break: keep-all !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            width: auto !important;
            min-width: fit-content !important;
            box-sizing: border-box !important;
        }
        
        .status-paid {
            background: #e8f5e8 !important;
            color: #2e7d32 !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-size: 11px !important;
            font-weight: bold !important;
            border: 1px solid #c8e6c9 !important;
            display: inline-block !important;
            white-space: nowrap !important;
            word-break: keep-all !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            width: auto !important;
            min-width: fit-content !important;
            box-sizing: border-box !important;
        }
        
        .status-cancelled {
            background: #ffebee !important;
            color: #c62828 !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-size: 11px !important;
            font-weight: bold !important;
            border: 1px solid #ffcdd2 !important;
            display: inline-block !important;
            white-space: nowrap !important;
            word-break: keep-all !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            width: auto !important;
            min-width: fit-content !important;
            box-sizing: border-box !important;
        }
        
        .status-partial {
            background: #f3e5f5 !important;
            color: #7b1fa2 !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-size: 11px !important;
            font-weight: bold !important;
            border: 1px solid #e1bee7 !important;
            display: inline-block !important;
            white-space: nowrap !important;
            word-break: keep-all !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            width: auto !important;
            min-width: fit-content !important;
            box-sizing: border-box !important;
        }
        
        /* Asegurar que los estilos de status se apliquen correctamente en las celdas de tabla */
        .facturas-table td .status-registered,
        .facturas-table td .status-pending,
        .facturas-table td .status-paid,
        .facturas-table td .status-cancelled,
        .facturas-table td .status-partial {
            display: inline-block !important;
            width: auto !important;
            min-width: fit-content !important;
            white-space: nowrap !important;
            word-break: keep-all !important;
            overflow: visible !important;
        }
    </style>
</head>
<body>
    <div class="facturacion-container">
        <!-- Navegaci√≥n superior -->
        <div class="top-navigation">
            <a href="dashboard.html" class="back-button">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
            
            <div class="nav-buttons">
                <button class="nav-button" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                
                <button class="nav-button active" onclick="showSection('ver-facturas')">
                    <i class="fas fa-list"></i> Ver Facturas
                </button>
                
                <button class="nav-button" onclick="window.location.href='Pago_fac.html'">
                    <i class="fas fa-money-bill-wave"></i> Pago Factura
                </button>
                
                <button class="nav-button" onclick="showSection('nueva-factura')">
                    <i class="fas fa-plus-circle"></i> Nueva Factura
                </button>
                
                <button class="nav-button" onclick="showSection('reportes')">
                    <i class="fas fa-chart-bar"></i> Reportes
                </button>
            </div>
        </div>
        
        <!-- √Årea de contenido -->
        <div class="content-area">
            <!-- Dashboard de Facturaci√≥n -->
            <div id="dashboard" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-file-invoice"></i> Dashboard de Facturaci√≥n</h1>
                    <p>Vista general del sistema de facturaci√≥n</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="stat-value" id="total-facturas">0</div>
                        <div class="stat-label">Total Facturas</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" id="total-facturado">$0.00</div>
                        <div class="stat-label">Total Facturado</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="stat-value" id="facturas-hoy">0</div>
                        <div class="stat-label">Facturas Hoy</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="clientes-unicos">0</div>
                        <div class="stat-label">Clientes √önicos</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-clock"></i> Actividad Reciente</h3>
                    </div>
                    <div class="table-content" id="recent-activity">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Cargando actividad reciente...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ver Facturas -->
            <div id="ver-facturas" class="content-section active">
                <div class="content-header">
                    <h1><i class="fas fa-list"></i> Ver Facturas</h1>
                    <p>Lista de todas las facturas registradas en el sistema</p>
                    
                    <!-- Leyenda de estatus -->
                    <div class="status-legend" style="display: flex; justify-content: center; gap: 15px; margin: 8px 0; flex-wrap: wrap;">
                        <div class="status-legend-item" style="display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold;">
                            <div class="status-legend-color" style="width: 12px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); background: #e3f2fd; border-color: #bbdefb;"></div>
                            <span>REGISTRADO</span>
                        </div>
                        <div class="status-legend-item" style="display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold;">
                            <div class="status-legend-color" style="width: 12px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); background: #fff8e1; border-color: #ffecb3;"></div>
                            <span>PENDIENTE</span>
                        </div>
                        <div class="status-legend-item" style="display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold;">
                            <div class="status-legend-color" style="width: 12px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); background: #e8f5e8; border-color: #c8e6c9;"></div>
                            <span>PAGADA</span>
                        </div>
                        <div class="status-legend-item" style="display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold;">
                            <div class="status-legend-color" style="width: 12px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); background: #f3e5f5; border-color: #e1bee7;"></div>
                            <span>PARCIAL</span>
                        </div>
                        <div class="status-legend-item" style="display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: bold;">
                            <div class="status-legend-color" style="width: 12px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); background: #ffebee; border-color: #ffcdd2;"></div>
                            <span>ANULADO</span>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n de subida de facturas - MISMAS DIMENSIONES QUE DIVISI√ìN 1 + T√çTULO -->
                <div class="table-container upload-section" style="background: var(--glass-bg) !important; backdrop-filter: var(--backdrop-filter) !important; border: 1px solid var(--glass-border) !important; border-radius: var(--border-radius-lg) !important; margin-bottom: 10px !important; box-shadow: var(--shadow-lg) !important; flex-shrink: 0 !important; height: 100px !important; min-height: 100px !important; max-height: 100px !important; display: flex !important; flex-direction: column !important;">
                    <div class="table-header" style="padding: 2px 8px !important; background: rgba(74, 222, 128, 0.1) !important; border-bottom: 1px solid var(--glass-border) !important; flex-shrink: 0 !important;">
                        <h3 style="font-size: 0.85rem !important; margin: 0 !important; color: var(--text-primary) !important;"><i class="fas fa-upload"></i> Subir Factura Individual</h3>
                    </div>
                    <div class="table-content" style="padding: 4px 12px !important; min-height: auto !important; max-height: none !important; height: auto !important; display: flex !important; align-items: center !important; justify-content: flex-start !important; flex: 1 !important;">
                        <div class="upload-controls" style="gap: 6px !important; margin-bottom: 0 !important; padding: 0 !important; height: 100% !important;">
                            <label style="gap: 4px !important; font-size: 13px !important; margin: 0 !important; padding: 0 !important;">
                                <span>Seleccionar archivo XML:</span>
                                <input type="file" id="file-input" accept=".xml" class="file-input-hidden">
                                <button onclick="document.getElementById('file-input').click()" class="btn btn-primary" style="padding: 6px 10px !important; font-size: 13px !important;">
                                    <i class="fas fa-folder-open"></i> Buscar Archivo XML
                                </button>
                            </label>
                        </div>
                        <div id="resultado-subida" style="margin-top: 0 !important;"></div>
                    </div>
                </div>
                
                <!-- Lista de facturas -->
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-file-invoice"></i> Facturas Registradas</h3>
                    </div>
                    <div class="table-content">
                        <div id="facturas-table-container">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando facturas...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Paginaci√≥n -->
                <div class="pagination-container" id="pagination-container" style="display: none;">
                    <div class="pagination-info">
                        <span id="pagination-info">Mostrando 0 de 0 facturas</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="prev-page" onclick="changePage(-1)">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <div class="page-numbers" id="page-numbers"></div>
                        <button class="pagination-btn" id="next-page" onclick="changePage(1)">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Pago Factura -->
            <div id="pago-factura" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-money-bill-wave"></i> Pago Factura</h1>
                    <p>Gestionar pagos de facturas pendientes</p>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-credit-card"></i> M√≥dulo de Pagos</h3>
                    </div>
                    <div class="table-content">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-credit-card" style="font-size: 4rem; color: #28a745; margin-bottom: 20px;"></i>
                            <h3>Gesti√≥n de Pagos</h3>
                            <p>Accede al m√≥dulo completo de pagos para gestionar facturas con saldo pendiente</p>
                            <button class="btn btn-primary" onclick="window.location.href='Pago_fac.html'">
                                <i class="fas fa-external-link-alt"></i> Ir al M√≥dulo de Pagos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Nueva Factura -->
            <div id="nueva-factura" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-plus-circle"></i> Nueva Factura</h1>
                    <p>Crear una nueva factura en el sistema</p>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-edit"></i> Formulario de Factura</h3>
                    </div>
                    <div class="table-content">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-edit" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                            <h3>Crear Nueva Factura</h3>
                            <p>Formulario para crear una nueva factura en el sistema</p>
                            <button class="btn btn-primary" onclick="nuevaFactura()">
                                <i class="fas fa-plus"></i> Crear Factura
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reportes -->
            <div id="reportes" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-chart-bar"></i> Reportes</h1>
                    <p>Reportes y estad√≠sticas de facturaci√≥n</p>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-chart-line"></i> Reportes Disponibles</h3>
                    </div>
                    <div class="table-content">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-chart-bar" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                            <h3>Reportes de Facturaci√≥n</h3>
                            <p>Generar reportes detallados de facturaci√≥n</p>
                            <button class="btn btn-primary" onclick="generarReporte()">
                                <i class="fas fa-chart-line"></i> Generar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar factura -->
    <div id="factura-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-invoice"></i> Confirmar Registro de Factura
                </h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-content">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirm" onclick="confirmarRegistro()">
                    <i class="fas fa-check"></i> S√≠, Registrar Factura
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar anulaci√≥n de factura -->
    <div id="anular-factura-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Anulaci√≥n
                </h3>
                <button class="modal-close" onclick="closeAnularModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="anular-modal-content">
                <p>¬øEst√°s seguro de que deseas anular la factura <strong id="anular-factura-numero"></strong>?</p>
                <p>Esta acci√≥n no se puede deshacer.</p>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeAnularModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirm-anular" onclick="confirmAnularFactura()">
                    <i class="fas fa-check"></i> S√≠, Anular Factura
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar detalles de la factura -->
    <div id="ver-factura-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-invoice-dollar"></i> Detalles de la Factura
                </h3>
                <button class="modal-close" onclick="closeVerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="ver-modal-content">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeVerModal()">
                    <i class="fas fa-times"></i> Salir
                </button>
                <button class="btn-confirm" onclick="generarRide()">
                    <i class="fas fa-file-pdf"></i> Generar RIDE o PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar pagos de la factura -->
    <div id="ver-pagos-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-money-bill-wave"></i> Historial de Pagos de la Factura
                </h3>
                <button class="modal-close" onclick="closePagosModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="ver-pagos-content">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closePagosModal()">
                    <i class="fas fa-times"></i> Salir
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let facturaData = null;
        let facturaIdParaAnular = null;
        let facturaIdParaVer = null;
        
        // Variables globales para ordenamiento
        let currentSort = 'fecha_emision';
        let currentOrder = 'DESC';
        
        // Variables globales para filtrado
        let currentStatusFilter = '';
        
        // Inicializar par√°metros de ordenamiento y filtrado desde la URL
        function initializeSortingFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const sortParam = urlParams.get('sort');
            const orderParam = urlParams.get('order');
            const statusParam = urlParams.get('status');
            
            if (sortParam && ['secuencial', 'fecha_emision', 'cliente'].includes(sortParam)) {
                currentSort = sortParam;
            }
            
            if (orderParam && ['ASC', 'DESC'].includes(orderParam.toUpperCase())) {
                currentOrder = orderParam.toUpperCase();
            }
            
            if (statusParam && ['', 'REGISTRADO', 'PAGADO', 'ANULADO', 'NOTA CR'].includes(statusParam)) {
                currentStatusFilter = statusParam;
            }
        }
        
        // Funci√≥n para cambiar secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            // Actualizar botones activos
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Marcar el bot√≥n correspondiente como activo
            event.target.closest('.nav-button').classList.add('active');
            
            // Cargar datos espec√≠ficos seg√∫n la secci√≥n
            if (sectionId === 'ver-facturas') {
                loadFacturasList();
            }
        }
        
        // Configurar el input de archivo
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // Inicializar par√°metros de ordenamiento desde la URL
            initializeSortingFromURL();
            
            // Cargar facturas al cargar la p√°gina
            loadFacturasList();
        });
        
        // Manejar selecci√≥n de archivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.xml')) {
                alert('Por favor selecciona un archivo XML v√°lido');
                return;
            }
            
            selectedFile = file;
            processXMLFile(file);
        }
        
        // Procesar archivo XML
        function processXMLFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const xmlContent = e.target.result;
                    console.log('Contenido XML cargado:', xmlContent.substring(0, 500) + '...');
                    
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    
                    // Verificar si el XML se parse√≥ correctamente
                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                        throw new Error('Error al parsear el XML. Verifica que sea un archivo XML v√°lido.');
                    }
                    
                    console.log('XML parseado correctamente');
                    
                    // Extraer informaci√≥n de la factura
                    facturaData = extractFacturaInfo(xmlDoc);
                    console.log('Datos extra√≠dos:', facturaData);
                    
                    // Mostrar modal con la informaci√≥n
                    showFacturaModal(facturaData, xmlContent);
                    
                } catch (error) {
                    console.error('Error procesando XML:', error);
                    alert('Error al procesar el archivo XML: ' + error.message + '\n\nVerifica que sea un archivo XML v√°lido de factura electr√≥nica.');
                }
            };
            
            reader.onerror = function() {
                console.error('Error leyendo archivo');
                alert('Error al leer el archivo. Verifica que sea un archivo v√°lido.');
            };
            
            reader.readAsText(file);
        }
        
        // Extraer informaci√≥n de la factura del XML
        function extractFacturaInfo(xmlDoc) {
            const factura = {};
            
            try {
                console.log('Iniciando extracci√≥n de datos del XML...');
                
                // Informaci√≥n b√°sica de la factura
                factura.estab = getXMLValue(xmlDoc, 'estab') || getXMLValue(xmlDoc, 'establecimiento') || 'N/A';
                factura.ptoEmi = getXMLValue(xmlDoc, 'ptoEmi') || getXMLValue(xmlDoc, 'puntoEmision') || 'N/A';
                factura.secuencial = getXMLValue(xmlDoc, 'secuencial') || 'N/A';
                factura.fechaEmision = getXMLValue(xmlDoc, 'fechaEmision') || getXMLValue(xmlDoc, 'fecha') || 'N/A';
                
                // Informaci√≥n del comprador
                factura.razonSocialComprador = getXMLValue(xmlDoc, 'razonSocialComprador') || getXMLValue(xmlDoc, 'razonSocial') || getXMLValue(xmlDoc, 'cliente') || 'N/A';
                factura.identificacionComprador = getXMLValue(xmlDoc, 'identificacionComprador') || getXMLValue(xmlDoc, 'ruc') || getXMLValue(xmlDoc, 'identificacion') || 'N/A';
                factura.direccionComprador = getXMLValue(xmlDoc, 'direccionComprador') || getXMLValue(xmlDoc, 'direccion') || 'N/A';
                
                // Informaci√≥n de la factura
                factura.importeTotal = getXMLValue(xmlDoc, 'importeTotal') || getXMLValue(xmlDoc, 'total') || '0.00';
                factura.moneda = getXMLValue(xmlDoc, 'moneda') || 'USD';
                
                // Clave de acceso (identificador √∫nico de la factura)
                factura.claveAcceso = getXMLValue(xmlDoc, 'claveAcceso') || getXMLValue(xmlDoc, 'claveAcceso', 'infoTributaria') || 'N/A';
                
                console.log('Datos b√°sicos extra√≠dos:', {
                    estab: factura.estab,
                    ptoEmi: factura.ptoEmi,
                    secuencial: factura.secuencial,
                    fechaEmision: factura.fechaEmision,
                    razonSocialComprador: factura.razonSocialComprador,
                    identificacionComprador: factura.identificacionComprador,
                    importeTotal: factura.importeTotal,
                    claveAcceso: factura.claveAcceso
                });
                
                // Extraer detalles de la factura
                factura.detalles = extractDetallesFactura(xmlDoc);
                console.log('Detalles extra√≠dos:', factura.detalles.length, 'items');
                
            } catch (error) {
                console.error('Error extrayendo informaci√≥n:', error);
                throw new Error('Error al extraer informaci√≥n del XML: ' + error.message);
            }
            
            return factura;
        }
        
        // Extraer detalles de la factura
        function extractDetallesFactura(xmlDoc) {
            const detalles = [];
            
            try {
                // Buscar elementos de detalle
                const detalleElements = xmlDoc.getElementsByTagName('detalle');
                
                for (let i = 0; i < detalleElements.length; i++) {
                    const detalle = detalleElements[i];
                    const item = {
                        codigoPrincipal: getElementValue(detalle, 'codigoPrincipal') || 'N/A',
                        descripcion: getElementValue(detalle, 'descripcion') || 'N/A',
                        cantidad: getElementValue(detalle, 'cantidad') || '0',
                        precioUnitario: getElementValue(detalle, 'precioUnitario') || '0.00',
                        descuento: getElementValue(detalle, 'descuento') || '0.00',
                        precioTotalSinImpuesto: getElementValue(detalle, 'precioTotalSinImpuesto') || '0.00'
                    };
                    detalles.push(item);
                }
            } catch (error) {
                console.error('Error extrayendo detalles:', error);
            }
            
            return detalles;
        }
        
        // Funci√≥n auxiliar para obtener valores del XML
        function getXMLValue(xmlDoc, tagName, parentTag = null) {
            let element = null;
            
            if (parentTag) {
                // Buscar dentro de un elemento padre espec√≠fico
                const parentElements = xmlDoc.getElementsByTagName(parentTag);
                if (parentElements.length > 0) {
                    const parentElement = parentElements[0];
                    const childElements = parentElement.getElementsByTagName(tagName);
                    if (childElements.length > 0) {
                        element = childElements[0];
                    }
                }
            } else {
                // Buscar directamente en el documento
                element = xmlDoc.getElementsByTagName(tagName)[0];
            }
            
            return element ? element.textContent : null;
        }
        
        // Funci√≥n auxiliar para obtener valores de elementos hijos
        function getElementValue(parent, tagName) {
            const element = parent.getElementsByTagName(tagName)[0];
            return element ? element.textContent : null;
        }
        
        // Mostrar modal con informaci√≥n de la factura
        function showFacturaModal(factura, xmlContent) {
            const modal = document.getElementById('factura-modal');
            const modalContent = document.getElementById('modal-content');
            
            let html = `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #007bff;">
                        <i class="fas fa-info-circle"></i> Informaci√≥n de la Factura a Registrar
                    </h4>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        Revisa la informaci√≥n antes de confirmar el registro. El sistema verificar√° autom√°ticamente si esta factura ya existe.
                    </p>
                </div>
                
                <div class="factura-info">
                    <div class="info-item">
                        <div class="info-label">Establecimiento</div>
                        <div class="info-value">${factura.estab}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Punto de Emisi√≥n</div>
                        <div class="info-value">${factura.ptoEmi}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Secuencial</div>
                        <div class="info-value">${factura.secuencial}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha de Emisi√≥n</div>
                        <div class="info-value">${factura.fechaEmision}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Raz√≥n Social Comprador</div>
                        <div class="info-value">${factura.razonSocialComprador}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Identificaci√≥n Comprador</div>
                        <div class="info-value">${factura.identificacionComprador}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Direcci√≥n Comprador</div>
                        <div class="info-value">${factura.direccionComprador}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Importe Total</div>
                        <div class="info-value">$${factura.importeTotal} ${factura.moneda}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Clave de Acceso</div>
                        <div class="info-value">${factura.claveAcceso}</div>
                    </div>
                </div>
            `;
            
            // Agregar detalles de la factura si existen
            if (factura.detalles && factura.detalles.length > 0) {
                html += `
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-primary);">
                        <i class="fas fa-list"></i> Detalles de la Factura (${factura.detalles.length} items)
                    </h4>
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">C√≥digo</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Descripci√≥n</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Cantidad</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Precio Unit.</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Descuento</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                factura.detalles.forEach((detalle, index) => {
                    const rowColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    html += `
                        <tr style="background: ${rowColor};">
                            <td style="padding: 6px; border: 1px solid #ddd; font-size: 11px;">${detalle.codigoPrincipal}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; font-size: 11px;">${detalle.descripcion}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${detalle.cantidad}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-size: 11px;">$${detalle.precioUnitario}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-size: 11px;">$${detalle.descuento}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-size: 11px; font-weight: bold;">$${detalle.precioTotalSinImpuesto}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <i class="fas fa-exclamation-triangle" style="color: #856404; margin-right: 8px;"></i>
                        <strong>Nota:</strong> No se encontraron detalles de la factura en el XML.
                    </div>
                `;
            }
            
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        
        // Escapar HTML para mostrar XML de forma segura
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Cerrar modal
        function closeModal() {
            const modal = document.getElementById('factura-modal');
            modal.classList.remove('active');
            selectedFile = null;
            facturaData = null;
            document.getElementById('file-input').value = '';
        }
        
        // Confirmar registro de factura
        function confirmarRegistro() {
            if (!selectedFile || !facturaData) {
                alert('No hay archivo seleccionado');
                return;
            }
            
            const formData = new FormData();
            formData.append('archivo_xml', selectedFile);
            formData.append('datos_factura', JSON.stringify(facturaData));
            
            // Mostrar indicador de carga
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;"></i>
                    <p>Registrando factura...</p>
                </div>
            `;
            
            fetch('api/upload_factura_individual.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 15px;"></i>
                            <h3 style="color: #28a745;">¬°Factura Registrada Exitosamente!</h3>
                            <p>La factura ha sido registrada en el sistema.</p>
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                <strong>Clave de Acceso:</strong> ${data.data.clave_acceso}<br>
                                <strong>Cliente:</strong> ${data.data.cliente}<br>
                                <strong>Total:</strong> $${data.data.total}
                            </div>
                        </div>
                    `;
                    
                    // Recargar la tabla de facturas despu√©s de 3 segundos
                    setTimeout(() => {
                        closeModal();
                        loadFacturasList();
                    }, 3000);
                } else {
                    // Determinar el tipo de error para mostrar el icono apropiado
                    let iconClass = 'fas fa-exclamation-triangle';
                    let iconColor = '#dc3545';
                    let titleColor = '#dc3545';
                    
                    if (data.message.includes('ya est√° registrada') || data.message.includes('ya existe')) {
                        iconClass = 'fas fa-info-circle';
                        iconColor = '#ffc107';
                        titleColor = '#ffc107';
                    }
                    
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="${iconClass}" style="font-size: 3rem; color: ${iconColor}; margin-bottom: 15px;"></i>
                            <h3 style="color: ${titleColor};">
                                ${data.message.includes('ya est√° registrada') ? 'Factura Ya Registrada' : 'Error al Registrar'}
                            </h3>
                            <p style="color: var(--text-secondary);">${data.message}</p>
                            ${data.message.includes('ya est√° registrada') ? `
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                    <strong>Informaci√≥n:</strong><br>
                                    ‚Ä¢ Esta factura ya existe en el sistema<br>
                                    ‚Ä¢ No se puede registrar la misma factura dos veces<br>
                                    ‚Ä¢ Verifica que no hayas subido este archivo anteriormente
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Si es un error de duplicado, cerrar el modal despu√©s de 5 segundos
                    if (data.message.includes('ya est√° registrada')) {
                        setTimeout(() => {
                            closeModal();
                        }, 5000);
                    }
                }
            })
            .catch(error => {
                console.error('Error registrando factura:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 15px;"></i>
                        <h3 style="color: #dc3545;">Error de Conexi√≥n</h3>
                        <p>Error al conectar con el servidor. Verifica tu conexi√≥n a internet.</p>
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin-top: 15px;">
                            <strong>Detalles del error:</strong><br>
                            ${error.message || 'Error desconocido'}
                        </div>
                    </div>
                `;
            });
        }
        
        // Cargar datos del dashboard
        function loadDashboardData() {
            // Cargar estad√≠sticas
            fetch('api/dashboard_stats.php', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('total-facturas').textContent = data.data.facturacion.total;
                    document.getElementById('total-facturado').textContent = '$' + parseFloat(data.data.facturacion.total_facturado_mes || 0).toFixed(2);
                    document.getElementById('facturas-hoy').textContent = data.data.facturacion.hoy;
                    document.getElementById('clientes-unicos').textContent = data.data.clientes.total;
                }
            })
            .catch(error => {
                console.error('Error cargando estad√≠sticas:', error);
            });
            
            // Cargar actividad reciente
            loadRecentActivity();
        }
        
        // Cargar actividad reciente
        function loadRecentActivity() {
            fetch('api/recent_activity.php', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRecentActivity(data.data);
                }
            })
            .catch(error => {
                console.error('Error cargando actividad:', error);
            });
        }
        
        // Mostrar actividad reciente
        function displayRecentActivity(activities) {
            const container = document.getElementById('recent-activity');
            
            if (activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay actividad reciente</p>';
                return;
            }
            
            let html = '';
            activities.forEach(activity => {
                html += `
                    <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--glass-border);">
                        <div style="width: 40px; height: 40px; background: ${getActivityColor(activity.color)}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                            <i class="${activity.icono}" style="color: white; font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">${activity.descripcion}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${activity.tiempo}</div>
                        </div>
                        ${activity.monto ? `<div style="font-weight: 600; color: var(--primary-color);">${activity.monto}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Obtener color de actividad
        function getActivityColor(color) {
            const colors = {
                'success': '#28a745',
                'info': '#17a2b8',
                'warning': '#ffc107',
                'danger': '#dc3545'
            };
            return colors[color] || '#6c757d';
        }
        
        // Cargar lista de facturas
        function loadFacturasList() {
            const container = document.getElementById('facturas-table-container');
            const paginationContainer = document.getElementById('pagination-container');
            
            if (!container) {
                console.error('No se encontr√≥ el contenedor facturas-table-container');
                return;
            }
            
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Cargando facturas...</p></div>';
            paginationContainer.style.display = 'none'; // Ocultar paginaci√≥n mientras carga
            
            // Obtener par√°metros de paginaci√≥n
            const urlParams = new URLSearchParams(window.location.search);
            const page = parseInt(urlParams.get('page')) || 1;
            const limit = 20; // N√∫mero de facturas por p√°gina
            
            // Construir URL con par√°metros de ordenamiento y filtrado
            let apiUrl = `api/get_facturas_simple.php?page=${page}&limit=${limit}&sort=${currentSort}&order=${currentOrder}`;
            
            // Agregar filtro de estatus si est√° activo
            if (currentStatusFilter) {
                apiUrl += `&status=${currentStatusFilter}`;
            }
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFacturasTable(data.data, data.pagination, data.sorting);
                    if (data.pagination.pages > 1) {
                        displayPagination(data.pagination);
                        paginationContainer.style.display = 'flex';
                    } else {
                        paginationContainer.style.display = 'none';
                    }
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                            <h3>Error al cargar facturas</h3>
                            <p>${data.message || 'Error desconocido'}</p>
                        </div>
                    `;
                    paginationContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error cargando facturas:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3>Error de Conexi√≥n</h3>
                        <p>Error al conectar con el servidor. Verifica tu conexi√≥n a internet.</p>
                    </div>
                `;
                paginationContainer.style.display = 'none';
            });
        }
        
        // Mostrar tabla de facturas
        function displayFacturasTable(facturas, pagination, sorting) {
            const container = document.getElementById('facturas-table-container');
            
            if (!container) {
                console.error('No se encontr√≥ el contenedor facturas-table-container');
                return;
            }
            
            if (!Array.isArray(facturas)) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3>Error en el formato de datos</h3>
                        <p>Los datos recibidos no tienen el formato esperado</p>
                    </div>
                `;
                return;
            }
            
            if (facturas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file-invoice" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                        <h3>No hay facturas registradas</h3>
                        <p>Sube facturas individuales para verlas aqu√≠</p>
                        <div style="background: #e7f3ff; border: 1px solid #b3d9ff; padding: 15px; border-radius: 5px; margin-top: 15px;">
                            <strong>üí° Consejo:</strong> Haz clic en "Buscar Archivo XML" para subir tu primera factura.
                        </div>
                    </div>
                `;
                return;
            }
            
            // Determinar clases de ordenamiento para los headers
            const getSortClass = (column) => {
                if (sorting && sorting.sort === column) {
                    return sorting.order === 'ASC' ? 'sort-asc' : 'sort-desc';
                }
                return '';
            };
            
            // Determinar clase de filtro para el header de estatus
            const getStatusFilterClass = () => {
                if (currentStatusFilter) {
                    return 'filter-active';
                }
                return '';
            };
            
            let html = `
                <table class="facturas-table">
                    <thead>
                        <tr>
                            <th>ESTAB</th>
                            <th>PTO EMI</th>
                            <th class="sortable-header ${getSortClass('secuencial')}" onclick="sortTable('secuencial')">SECUENCIAL</th>
                            <th class="sortable-header ${getSortClass('fecha_emision')}" onclick="sortTable('fecha_emision')">FECHA EMISI√ìN</th>
                            <th class="sortable-header ${getSortClass('cliente')}" onclick="sortTable('cliente')">CLIENTE</th>
                            <th>DIRECCI√ìN</th>
                            <th>TOTAL</th>
                            <th class="filterable-header ${getStatusFilterClass()}" onclick="showStatusFilter()">ESTATUS ${currentStatusFilter ? `(${currentStatusFilter})` : ''}</th>
                            <th>RETENCI√ìN</th>
                            <th>VALOR PAGADO</th>
                            <th>ACCIONES</th> 
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            facturas.forEach(factura => {
                const numeroFactura = `${factura.estab || ''}-${factura.pto_emi || ''}-${factura.secuencial || ''}`;
                
                let dropdownItems = `
                    <a href="#" onclick="event.preventDefault(); showVerFactura('${factura.clave_acceso}');">
                        <i class="fas fa-eye"></i> Ver Factura
                    </a>
                `;
                
                // Mostrar "Ver Pagos" solo para facturas PAGADA o PENDIENTE
                if (factura.estatus === 'PAGADA' || factura.estatus === 'PENDIENTE') {
                    dropdownItems += `
                        <a href="#" onclick="event.preventDefault(); showPagosFactura('${factura.clave_acceso}', ${factura.id});">
                            <i class="fas fa-money-bill-wave"></i> Ver Pagos
                        </a>
                    `;
                }

                if (factura.estatus === 'REGISTRADO') {
                    dropdownItems += `
                        <a href="#" onclick="event.preventDefault(); showAnularConfirm(${factura.id}, '${numeroFactura}');">
                            <i class="fas fa-ban"></i> Anular Factura
                        </a>
                    `;
                }

                const actionsHtml = `
                    <div class="dropdown">
                        <button class="btn-actions" onclick="toggleDropdown(event)">
                            Acciones <i class="fas fa-caret-down"></i>
                        </button>
                        <div class="dropdown-content">
                            ${dropdownItems}
                        </div>
                    </div>
                `;

                html += `
                    <tr>
                        <td>${factura.estab || 'N/A'}</td>
                        <td>${factura.pto_emi || 'N/A'}</td>
                        <td>${factura.secuencial || 'N/A'}</td>
                        <td>${factura.fecha_emision || 'N/A'}</td>
                        <td>${factura.cliente || 'N/A'}</td>
                        <td>${factura.direccion || 'N/A'}</td>
                        <td>$${factura.total || '0.00'}</td>
                        <td><span class="${getStatusClass(factura.estatus)}">${factura.estatus || 'REGISTRADO'}</span></td>
                        <td>$${factura.retencion || '0.00'}</td>
                        <td>$${factura.valor_pagado || '0.00'}</td>
                        <td class="actions-cell">
                            ${actionsHtml}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Funci√≥n para ordenar la tabla
        function sortTable(column) {
            // Si se hace clic en la misma columna, cambiar el orden
            if (currentSort === column) {
                currentOrder = currentOrder === 'ASC' ? 'DESC' : 'ASC';
            } else {
                // Si es una nueva columna, establecer orden ascendente por defecto
                currentSort = column;
                currentOrder = 'ASC';
            }
            
            // Actualizar URL con los par√°metros de ordenamiento
            const url = new URL(window.location);
            url.searchParams.set('sort', currentSort);
            url.searchParams.set('order', currentOrder);
            url.searchParams.set('page', '1'); // Resetear a la primera p√°gina al ordenar
            window.history.pushState({}, '', url);
            
            // Recargar la tabla con los nuevos par√°metros de ordenamiento
            loadFacturasList();
        }
        
        // Funci√≥n para obtener la clase CSS del estatus
        function getStatusClass(status) {
            switch(status.toUpperCase()) {
                case 'REGISTRADO':
                    return 'status-registered';
                case 'PENDIENTE':
                    return 'status-pending';
                case 'PAGADA':
                    return 'status-paid';
                case 'CANCELADA':
                case 'ANULADA':
                case 'ANULADO':
                    return 'status-cancelled';
                case 'PARCIAL':
                    return 'status-partial';
                default:
                    return 'status-registered';
            }
        }
        
        // Funci√≥n para mostrar filtro de estatus
        function showStatusFilter() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 400px;
                width: 90%;
            `;
            
            modalContent.innerHTML = `
                <h3 style="margin-top: 0; color: #333;">Filtrar por Estatus</h3>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Selecciona un estatus:</label>
                    <select id="status-filter-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Todos los estatus</option>
                        <option value="REGISTRADO" ${currentStatusFilter === 'REGISTRADO' ? 'selected' : ''}>REGISTRADO</option>
                        <option value="PENDIENTE" ${currentStatusFilter === 'PENDIENTE' ? 'selected' : ''}>PENDIENTE</option>
                        <option value="PAGADA" ${currentStatusFilter === 'PAGADA' ? 'selected' : ''}>PAGADA</option>
                        <option value="PARCIAL" ${currentStatusFilter === 'PARCIAL' ? 'selected' : ''}>PARCIAL</option>
                        <option value="CANCELADA" ${currentStatusFilter === 'CANCELADA' ? 'selected' : ''}>CANCELADA</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeStatusFilter()" style="padding: 8px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; cursor: pointer;">Cancelar</button>
                    <button onclick="applyStatusFilter()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Aplicar Filtro</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera de √©l
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeStatusFilter();
                }
            });
        }
        
        // Funci√≥n para cerrar el filtro de estatus
        function closeStatusFilter() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Funci√≥n para aplicar el filtro de estatus
        function applyStatusFilter() {
            const select = document.getElementById('status-filter-select');
            const newStatusFilter = select.value;
            
            // Actualizar URL con el nuevo filtro
            const url = new URL(window.location);
            if (newStatusFilter) {
                url.searchParams.set('status', newStatusFilter);
            } else {
                url.searchParams.delete('status');
            }
            url.searchParams.set('page', '1'); // Resetear a la primera p√°gina al filtrar
            window.history.pushState({}, '', url);
            
            // Actualizar variable global
            currentStatusFilter = newStatusFilter;
            
            // Cerrar modal y recargar la tabla
            closeStatusFilter();
            loadFacturasList();
        }
        
        // Funciones para los botones
        function downloadFacturas() {
            alert('Funci√≥n de descarga de facturas en desarrollo');
        }
        
        function nuevaFactura() {
            alert('Funci√≥n de nueva factura en desarrollo');
        }
        
        function generarReporte() {
            alert('Funci√≥n de reportes en desarrollo');
        }

        function generarRide() {
            if (!facturaIdParaVer) {
                alert('No hay factura seleccionada para generar RIDE.');
                return;
            }
            // Abre el script del PDF en una nueva pesta√±a, pasando la clave de acceso
            const url = `api/generar_pdf.php?clave_acceso=${facturaIdParaVer}`;
            window.open(url, '_blank');
        }

        // Funci√≥n para cambiar de p√°gina
        function changePage(direction) {
            const urlParams = new URLSearchParams(window.location.search);
            const currentPage = parseInt(urlParams.get('page')) || 1;
            const newPage = currentPage + direction;
            
            if (newPage >= 1) {
                const url = new URL(window.location);
                url.searchParams.set('page', newPage);
                window.history.pushState({}, '', url);
                loadFacturasList();
            }
        }
        
        // Funci√≥n para ir a una p√°gina espec√≠fica
        function goToPage(page) {
            const url = new URL(window.location);
            url.searchParams.set('page', page);
            window.history.pushState({}, '', url);
            loadFacturasList();
        }
        
        // Mostrar paginaci√≥n
        function displayPagination(pagination) {
            const paginationInfo = document.getElementById('pagination-info');
            const pageNumbers = document.getElementById('page-numbers');
            const prevPage = document.getElementById('prev-page');
            const nextPage = document.getElementById('next-page');
            
            // Actualizar informaci√≥n de paginaci√≥n
            if (paginationInfo) {
                paginationInfo.textContent = `Mostrando ${pagination.start} a ${pagination.end} de ${pagination.total} facturas`;
            }
            
            // Actualizar botones de navegaci√≥n
            if (prevPage) {
                prevPage.disabled = !pagination.has_prev;
                prevPage.classList.toggle('disabled', !pagination.has_prev);
            }
            
            if (nextPage) {
                nextPage.disabled = !pagination.has_next;
                nextPage.classList.toggle('disabled', !pagination.has_next);
            }
            
            // Generar n√∫meros de p√°gina
            if (pageNumbers) {
                let html = '';
                const maxPages = 5;
                let startPage = Math.max(1, pagination.page - Math.floor(maxPages / 2));
                let endPage = Math.min(pagination.pages, startPage + maxPages - 1);
                
                if (endPage - startPage + 1 < maxPages) {
                    startPage = Math.max(1, endPage - maxPages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const activeClass = i === pagination.page ? 'active' : '';
                    html += `<span class="page-number ${activeClass}" onclick="goToPage(${i})">${i}</span>`;
                }
                
                pageNumbers.innerHTML = html;
            }
        }

        // --- FUNCIONES DE ANULACI√ìN ---

        function showAnularConfirm(facturaId, numeroFactura) {
            facturaIdParaAnular = facturaId;
            document.getElementById('anular-factura-numero').textContent = numeroFactura;
            document.getElementById('anular-factura-modal').classList.add('active');
        }

        function closeAnularModal() {
            document.getElementById('anular-factura-modal').classList.remove('active');
            facturaIdParaAnular = null;
            
            // Restaurar el contenido original del modal para la pr√≥xima anulaci√≥n
            const modalContent = document.getElementById('anular-modal-content');
            if (modalContent) {
                modalContent.innerHTML = `
                    <p>¬øEst√°s seguro de que deseas anular la factura <strong id="anular-factura-numero"></strong>?</p>
                    <p>Esta acci√≥n no se puede deshacer.</p>
                `;
            }
        }

        function confirmAnularFactura() {
            if (!facturaIdParaAnular) return;

            const modalContent = document.getElementById('anular-modal-content');
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <p>Anulando factura...</p>
                </div>
            `;

            fetch('api/anular_factura.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: facturaIdParaAnular })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745;"></i>
                            <h4 style="color: #28a745;">¬°Factura Anulada!</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                    setTimeout(() => {
                        closeAnularModal();
                        loadFacturasList();
                    }, 2000);
                } else {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                            <h4 style="color: #dc3545;">Error al Anular</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error al anular factura:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                        <h4 style="color: #dc3545;">Error de Conexi√≥n</h4>
                        <p>No se pudo comunicar con el servidor.</p>
                    </div>
                `;
            });
        }

        // --- FUNCIONES PARA VER FACTURA ---
        
        function showVerFactura(claveAcceso) {
            if (!claveAcceso) {
                alert('No se pudo obtener la clave de acceso de la factura.');
                return;
            }
            facturaIdParaVer = claveAcceso; // Reutilizamos la variable para la clave
            const modal = document.getElementById('ver-factura-modal');
            const modalContent = document.getElementById('ver-modal-content');
            modalContent.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Cargando detalles...</p></div>';
            modal.classList.add('active');

            fetch(`api/get_factura_details.php?clave_acceso=${claveAcceso}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayFacturaDetalles(data.data);
                    } else {
                        modalContent.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error al obtener detalles:', error);
                    modalContent.innerHTML = `<p style="color: red;">Error de conexi√≥n al obtener los detalles.</p>`;
                });
        }

        function closeVerModal() {
            document.getElementById('ver-factura-modal').classList.remove('active');
            facturaIdParaVer = null;
        }

        function displayFacturaDetalles(factura) {
            const modalContent = document.getElementById('ver-modal-content');
            
            let detallesHtml = '<p>No se encontraron detalles para esta factura.</p>';
            if (factura.detalles && factura.detalles.length > 0) {
                detallesHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">C√≥digo</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Descripci√≥n</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Cant.</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">P. Unit.</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Desc.</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                factura.detalles.forEach(d => {
                    detallesHtml += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${d.codigo_principal}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${d.descripcion}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${parseFloat(d.cantidad).toFixed(2)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${parseFloat(d.precio_unitario).toFixed(2)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">$${parseFloat(d.descuento).toFixed(2)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: bold;">$${parseFloat(d.precio_total_sin_impuesto).toFixed(2)}</td>
                        </tr>
                    `;
                });
                detallesHtml += '</tbody></table>';
            }

            const html = `
                <div class="factura-info">
                    <div class="info-item"><strong>Cliente:</strong> ${factura.razon_social_comprador}</div>
                    <div class="info-item"><strong>Identificaci√≥n:</strong> ${factura.identificacion_comprador}</div>
                    <div class="info-item"><strong>Factura No:</strong> ${factura.estab}-${factura.pto_emi}-${factura.secuencial}</div>
                    <div class="info-item"><strong>Fecha Emisi√≥n:</strong> ${new Date(factura.fecha_emision).toLocaleDateString()}</div>
                    <div class="info-item"><strong>Total:</strong> $${parseFloat(factura.importe_total).toFixed(2)}</div>
                    <div class="info-item"><strong>Estado:</strong> <span class="${getStatusClass(factura.estatus)}">${factura.estatus}</span></div>
                    <div class="info-item" style="grid-column: 1 / -1;"><strong>Direcci√≥n:</strong> ${factura.direccion_comprador}</div>
                    <div class="info-item" style="grid-column: 1 / -1;"><strong>Clave de Acceso:</strong> ${factura.clave_acceso}</div>
                </div>
                <h4 style="margin-top: 20px;">Detalles</h4>
                ${detallesHtml}
            `;
            modalContent.innerHTML = html;
        }

        // --- FUNCIONES PARA VER PAGOS DE FACTURA ---
        function showPagosFactura(claveAcceso, facturaId) {
            if (!claveAcceso && !facturaId) {
                alert('No se pudo obtener la informaci√≥n de la factura.');
                return;
            }
            
            const modal = document.getElementById('ver-pagos-modal');
            const modalContent = document.getElementById('ver-pagos-content');
            modalContent.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Cargando pagos...</p></div>';
            modal.classList.add('active');

            // Construir la URL con los par√°metros disponibles
            let url = 'api/get_pagos_factura.php?';
            if (claveAcceso) {
                url += `clave_acceso=${claveAcceso}`;
            } else {
                url += `factura_id=${facturaId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayPagosFactura(data.data);
                    } else {
                        modalContent.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error al obtener pagos:', error);
                    modalContent.innerHTML = `<p style="color: red;">Error de conexi√≥n al obtener los pagos.</p>`;
                });
        }

        function closePagosModal() {
            document.getElementById('ver-pagos-modal').classList.remove('active');
        }

        function displayPagosFactura(data) {
            const modalContent = document.getElementById('ver-pagos-content');
            
            let pagosHtml = '<p>No se encontraron pagos para esta factura.</p>';
            
            if (data.pagos && data.pagos.length > 0) {
                pagosHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Fecha</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">M√©todo</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Instituci√≥n</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Documento</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Referencia</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Monto</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.pagos.forEach(pago => {
                    pagosHtml += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${new Date(pago.created_at).toLocaleDateString()}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${pago.formaPago || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">-</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">-</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">-</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: bold;">$${parseFloat(pago.total).toFixed(2)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">
                                <span class="status-paid">Confirmado</span>
                            </td>
                        </tr>
                    `;
                });
                
                pagosHtml += '</tbody></table>';
            }

            // Informaci√≥n de resumen
            let resumenHtml = '';
            if (data.resumen && data.resumen.factura_info) {
                const factura = data.resumen.factura_info;
                resumenHtml = `
                    <div class="factura-info" style="margin-bottom: 20px;">
                        <div class="info-item"><strong>Cliente:</strong> ${factura.cliente}</div>
                        <div class="info-item"><strong>Factura No:</strong> ${factura.estab}-${factura.pto_emi}-${factura.secuencial}</div>
                        <div class="info-item"><strong>Total Factura:</strong> $${parseFloat(factura.total_factura).toFixed(2)}</div>
                        <div class="info-item"><strong>Valor Pagado:</strong> $${parseFloat(factura.valor_pagado).toFixed(2)}</div>
                        <div class="info-item"><strong>Saldo Actual:</strong> $${parseFloat(factura.saldo_actual).toFixed(2)}</div>
                        <div class="info-item"><strong>Total Pagos:</strong> ${data.resumen.total_pagos}</div>
                        <div class="info-item"><strong>Monto Total Pagado:</strong> $${parseFloat(data.resumen.total_pagado).toFixed(2)}</div>
                    </div>
                `;
            }

            const html = `
                ${resumenHtml}
                <h4 style="margin-top: 20px;">Historial de Pagos</h4>
                ${pagosHtml}
            `;
            modalContent.innerHTML = html;
        }

        // --- FUNCIONES PARA DROPDOWN DE ACCIONES ---
        function toggleDropdown(event) {
            event.stopPropagation();
            const button = event.currentTarget;
            const dropdownContent = button.nextElementSibling;

            // Cerrar todos los dem√°s dropdowns abiertos antes de mostrar/ocultar el actual
            document.querySelectorAll('.dropdown-content.show').forEach(dd => {
                if (dd !== dropdownContent) {
                    dd.classList.remove('show');
                }
            });

            dropdownContent.classList.toggle('show');
        }

        // Cerrar todos los dropdowns si se hace clic fuera de ellos
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-content.show').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        });
    </script>
    
    <style>
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-filter);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .factura-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .factura-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background: rgba(74, 222, 128, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }
        
        .info-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--glass-border);
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        .btn-confirm {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-confirm:hover {
            background: #28a745;
        }
        
        .file-input-hidden {
            display: none;
        }

        /* Estilos para el bot√≥n de anular */
        .actions-cell {
            text-align: right;
            padding-right: 10px; /* A√±ade un poco de espacio al borde */
            overflow: visible !important; /* Para que el dropdown no se corte */
        }

        .btn-ver {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background-color 0.2s;
        }

        .btn-ver:hover {
            background: #138496;
        }

        .btn-anular {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background-color 0.2s;
        }

        .btn-anular:hover {
            background: #c82333;
        }

        .btn-confirm-anular {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-confirm-anular:hover {
            background: #c82333;
        }

        /* Estilos para el dropdown de acciones */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .btn-actions {
            background: #007bff;
            color: white;
            padding: 5px 10px;
            font-size: 11px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }

        .btn-actions:hover {
            background: #0056b3;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px; /* Un ancho m√≠nimo razonable */
            width: auto; /* Permitir que el ancho se ajuste al contenido */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 101; /* Encima de la fila de la tabla */
            border-radius: 5px;
            border: 1px solid var(--glass-border);
            overflow: hidden;
            right: 0;
            left: auto;
        }

        .dropdown-content a {
            color: var(--text-primary);
            padding: 12px 20px; /* Aumentar padding para m√°s espacio */
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px; /* Aumentar gap */
            font-size: 13px; /* Aumentar tama√±o de fuente */
            transition: background-color 0.2s;
            white-space: nowrap; /* Forzar que el texto no se divida en l√≠neas */
        }

        .dropdown-content a:hover {
            background-color: rgba(74, 222, 128, 0.1);
        }
        
        .dropdown-content.show {
            display: block;
        }
    </style>
</body>
</html> 