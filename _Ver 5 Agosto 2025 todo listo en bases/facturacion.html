<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturación - Sistema de Control GloboCity</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .facturacion-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            margin-top: 20px;
        }
        
        .top-navigation {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-filter);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-button {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .nav-button:hover {
            background: rgba(74, 222, 128, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .nav-button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .nav-button i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .back-button {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button:hover {
            background: rgba(74, 222, 128, 0.1);
            transform: translateX(-5px);
        }
        
        .content-area {
            flex: 1;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-filter);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .content-area::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            opacity: 0.1;
            border-radius: 50%;
            z-index: -1;
        }
        
        .content-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .content-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .content-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card .stat-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .stat-card .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .table-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .table-header {
            background: rgba(74, 222, 128, 0.1);
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .table-header h3 {
            margin: 0;
            color: var(--text-primary);
        }
        
        .table-content {
            padding: 20px;
            overflow-x: auto;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        /* Estilos para la tabla responsiva */
        .facturas-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .facturas-table th {
            background: #007bff;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .facturas-table td {
            padding: 6px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        
        .facturas-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .facturas-table tr:hover {
            background: #e3f2fd;
        }
        
        /* Controles de subida */
        .upload-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .upload-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .upload-controls input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 8px;
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            background: var(--glass-bg);
        }
        
        .upload-controls input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .file-input-hidden {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .nav-button {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .content-header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="facturacion-container">
        <!-- Navegación superior -->
        <div class="top-navigation">
            <a href="dashboard.html" class="back-button">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
            
            <div class="nav-buttons">
                <button class="nav-button" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                
                <button class="nav-button active" onclick="showSection('ver-facturas')">
                    <i class="fas fa-list"></i> Ver Facturas
                </button>
                
                <button class="nav-button" onclick="showSection('bajar-facturas')">
                    <i class="fas fa-download"></i> Bajar Facturas
                </button>
                
                <button class="nav-button" onclick="showSection('nueva-factura')">
                    <i class="fas fa-plus-circle"></i> Nueva Factura
                </button>
                
                <button class="nav-button" onclick="showSection('reportes')">
                    <i class="fas fa-chart-bar"></i> Reportes
                </button>
            </div>
        </div>
        
        <!-- Área de contenido -->
        <div class="content-area">
            <!-- Dashboard de Facturación -->
            <div id="dashboard" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-file-invoice"></i> Dashboard de Facturación</h1>
                    <p>Vista general del sistema de facturación</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="stat-value" id="total-facturas">0</div>
                        <div class="stat-label">Total Facturas</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" id="total-facturado">$0.00</div>
                        <div class="stat-label">Total Facturado</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="stat-value" id="facturas-hoy">0</div>
                        <div class="stat-label">Facturas Hoy</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="clientes-unicos">0</div>
                        <div class="stat-label">Clientes Únicos</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-clock"></i> Actividad Reciente</h3>
                    </div>
                    <div class="table-content" id="recent-activity">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Cargando actividad reciente...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ver Facturas -->
            <div id="ver-facturas" class="content-section active">
                <div class="content-header">
                    <h1><i class="fas fa-list"></i> Ver Facturas</h1>
                    <p>Lista de todas las facturas registradas en el sistema</p>
                </div>
                
                <!-- Sección de subida de facturas -->
                <div class="table-container" style="margin-bottom: 20px;">
                    <div class="table-header">
                        <h3><i class="fas fa-upload"></i> Subir Factura Individual</h3>
                    </div>
                    <div class="table-content">
                        <div class="upload-controls">
                            <label>
                                <span>Seleccionar archivo XML:</span>
                                <input type="file" id="file-input" accept=".xml" class="file-input-hidden">
                                <button onclick="document.getElementById('file-input').click()" class="btn btn-primary" style="padding: 8px 16px;">
                                    <i class="fas fa-folder-open"></i> Buscar Archivo XML
                                </button>
                            </label>
                        </div>
                        <div id="resultado-subida" style="margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Lista de facturas -->
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-file-invoice"></i> Facturas Registradas</h3>
                    </div>
                    <div class="table-content">
                        <div id="facturas-table-container">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando facturas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bajar Facturas -->
            <div id="bajar-facturas" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-download"></i> Bajar Facturas</h1>
                    <p>Descargar facturas en formato PDF</p>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-file-pdf"></i> Descargas Disponibles</h3>
                    </div>
                    <div class="table-content">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-file-pdf" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                            <h3>Descarga de Facturas</h3>
                            <p>Selecciona las facturas que deseas descargar en formato PDF</p>
                            <button class="btn btn-primary" onclick="downloadFacturas()">
                                <i class="fas fa-download"></i> Descargar Seleccionadas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Nueva Factura -->
            <div id="nueva-factura" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-plus-circle"></i> Nueva Factura</h1>
                    <p>Crear una nueva factura en el sistema</p>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-edit"></i> Formulario de Factura</h3>
                    </div>
                    <div class="table-content">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-edit" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                            <h3>Crear Nueva Factura</h3>
                            <p>Formulario para crear una nueva factura en el sistema</p>
                            <button class="btn btn-primary" onclick="nuevaFactura()">
                                <i class="fas fa-plus"></i> Crear Factura
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reportes -->
            <div id="reportes" class="content-section">
                <div class="content-header">
                    <h1><i class="fas fa-chart-bar"></i> Reportes</h1>
                    <p>Reportes y estadísticas de facturación</p>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-chart-line"></i> Reportes Disponibles</h3>
                    </div>
                    <div class="table-content">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-chart-bar" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                            <h3>Reportes de Facturación</h3>
                            <p>Generar reportes detallados de facturación</p>
                            <button class="btn btn-primary" onclick="generarReporte()">
                                <i class="fas fa-chart-line"></i> Generar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar factura -->
    <div id="factura-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-invoice"></i> Confirmar Registro de Factura
                </h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-content">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirm" onclick="confirmarRegistro()">
                    <i class="fas fa-check"></i> Sí, Registrar Factura
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let facturaData = null;
        
        // Función para cambiar secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la sección seleccionada
            document.getElementById(sectionId).classList.add('active');
            
            // Actualizar botones activos
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Marcar el botón correspondiente como activo
            event.target.closest('.nav-button').classList.add('active');
            
            // Cargar datos específicos según la sección
            if (sectionId === 'ver-facturas') {
                loadFacturasList();
            }
        }
        
        // Configurar el input de archivo
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // Cargar facturas al cargar la página
            loadFacturasList();
        });
        
        // Manejar selección de archivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.xml')) {
                alert('Por favor selecciona un archivo XML válido');
                return;
            }
            
            selectedFile = file;
            processXMLFile(file);
        }
        
        // Procesar archivo XML
        function processXMLFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const xmlContent = e.target.result;
                    console.log('Contenido XML cargado:', xmlContent.substring(0, 500) + '...');
                    
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    
                    // Verificar si el XML se parseó correctamente
                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                        throw new Error('Error al parsear el XML. Verifica que sea un archivo XML válido.');
                    }
                    
                    console.log('XML parseado correctamente');
                    
                    // Extraer información de la factura
                    facturaData = extractFacturaInfo(xmlDoc);
                    console.log('Datos extraídos:', facturaData);
                    
                    // Mostrar modal con la información
                    showFacturaModal(facturaData, xmlContent);
                    
                } catch (error) {
                    console.error('Error procesando XML:', error);
                    alert('Error al procesar el archivo XML: ' + error.message + '\n\nVerifica que sea un archivo XML válido de factura electrónica.');
                }
            };
            
            reader.onerror = function() {
                console.error('Error leyendo archivo');
                alert('Error al leer el archivo. Verifica que sea un archivo válido.');
            };
            
            reader.readAsText(file);
        }
        
        // Extraer información de la factura del XML
        function extractFacturaInfo(xmlDoc) {
            const factura = {};
            
            try {
                console.log('Iniciando extracción de datos del XML...');
                
                // Información básica de la factura
                factura.estab = getXMLValue(xmlDoc, 'estab') || getXMLValue(xmlDoc, 'establecimiento') || 'N/A';
                factura.ptoEmi = getXMLValue(xmlDoc, 'ptoEmi') || getXMLValue(xmlDoc, 'puntoEmision') || 'N/A';
                factura.secuencial = getXMLValue(xmlDoc, 'secuencial') || 'N/A';
                factura.fechaEmision = getXMLValue(xmlDoc, 'fechaEmision') || getXMLValue(xmlDoc, 'fecha') || 'N/A';
                
                // Información del comprador
                factura.razonSocialComprador = getXMLValue(xmlDoc, 'razonSocialComprador') || getXMLValue(xmlDoc, 'razonSocial') || getXMLValue(xmlDoc, 'cliente') || 'N/A';
                factura.identificacionComprador = getXMLValue(xmlDoc, 'identificacionComprador') || getXMLValue(xmlDoc, 'ruc') || getXMLValue(xmlDoc, 'identificacion') || 'N/A';
                factura.direccionComprador = getXMLValue(xmlDoc, 'direccionComprador') || getXMLValue(xmlDoc, 'direccion') || 'N/A';
                
                // Información de la factura
                factura.importeTotal = getXMLValue(xmlDoc, 'importeTotal') || getXMLValue(xmlDoc, 'total') || '0.00';
                factura.moneda = getXMLValue(xmlDoc, 'moneda') || 'USD';
                
                // Clave de acceso (identificador único de la factura)
                factura.claveAcceso = getXMLValue(xmlDoc, 'claveAcceso') || getXMLValue(xmlDoc, 'claveAcceso', 'infoTributaria') || 'N/A';
                
                console.log('Datos básicos extraídos:', {
                    estab: factura.estab,
                    ptoEmi: factura.ptoEmi,
                    secuencial: factura.secuencial,
                    fechaEmision: factura.fechaEmision,
                    razonSocialComprador: factura.razonSocialComprador,
                    identificacionComprador: factura.identificacionComprador,
                    importeTotal: factura.importeTotal,
                    claveAcceso: factura.claveAcceso
                });
                
                // Extraer detalles de la factura
                factura.detalles = extractDetallesFactura(xmlDoc);
                console.log('Detalles extraídos:', factura.detalles.length, 'items');
                
            } catch (error) {
                console.error('Error extrayendo información:', error);
                throw new Error('Error al extraer información del XML: ' + error.message);
            }
            
            return factura;
        }
        
        // Extraer detalles de la factura
        function extractDetallesFactura(xmlDoc) {
            const detalles = [];
            
            try {
                // Buscar elementos de detalle
                const detalleElements = xmlDoc.getElementsByTagName('detalle');
                
                for (let i = 0; i < detalleElements.length; i++) {
                    const detalle = detalleElements[i];
                    const item = {
                        codigoPrincipal: getElementValue(detalle, 'codigoPrincipal') || 'N/A',
                        descripcion: getElementValue(detalle, 'descripcion') || 'N/A',
                        cantidad: getElementValue(detalle, 'cantidad') || '0',
                        precioUnitario: getElementValue(detalle, 'precioUnitario') || '0.00',
                        descuento: getElementValue(detalle, 'descuento') || '0.00',
                        precioTotalSinImpuesto: getElementValue(detalle, 'precioTotalSinImpuesto') || '0.00'
                    };
                    detalles.push(item);
                }
            } catch (error) {
                console.error('Error extrayendo detalles:', error);
            }
            
            return detalles;
        }
        
        // Función auxiliar para obtener valores del XML
        function getXMLValue(xmlDoc, tagName, parentTag = null) {
            let element = null;
            
            if (parentTag) {
                // Buscar dentro de un elemento padre específico
                const parentElements = xmlDoc.getElementsByTagName(parentTag);
                if (parentElements.length > 0) {
                    const parentElement = parentElements[0];
                    const childElements = parentElement.getElementsByTagName(tagName);
                    if (childElements.length > 0) {
                        element = childElements[0];
                    }
                }
            } else {
                // Buscar directamente en el documento
                element = xmlDoc.getElementsByTagName(tagName)[0];
            }
            
            return element ? element.textContent : null;
        }
        
        // Función auxiliar para obtener valores de elementos hijos
        function getElementValue(parent, tagName) {
            const element = parent.getElementsByTagName(tagName)[0];
            return element ? element.textContent : null;
        }
        
        // Mostrar modal con información de la factura
        function showFacturaModal(factura, xmlContent) {
            const modal = document.getElementById('factura-modal');
            const modalContent = document.getElementById('modal-content');
            
            let html = `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #007bff;">
                        <i class="fas fa-info-circle"></i> Información de la Factura a Registrar
                    </h4>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        Revisa la información antes de confirmar el registro. El sistema verificará automáticamente si esta factura ya existe.
                    </p>
                </div>
                
                <div class="factura-info">
                    <div class="info-item">
                        <div class="info-label">Establecimiento</div>
                        <div class="info-value">${factura.estab}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Punto de Emisión</div>
                        <div class="info-value">${factura.ptoEmi}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Secuencial</div>
                        <div class="info-value">${factura.secuencial}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha de Emisión</div>
                        <div class="info-value">${factura.fechaEmision}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Razón Social Comprador</div>
                        <div class="info-value">${factura.razonSocialComprador}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Identificación Comprador</div>
                        <div class="info-value">${factura.identificacionComprador}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Dirección Comprador</div>
                        <div class="info-value">${factura.direccionComprador}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Importe Total</div>
                        <div class="info-value">$${factura.importeTotal} ${factura.moneda}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Clave de Acceso</div>
                        <div class="info-value">${factura.claveAcceso}</div>
                    </div>
                </div>
            `;
            
            // Agregar detalles de la factura si existen
            if (factura.detalles && factura.detalles.length > 0) {
                html += `
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-primary);">
                        <i class="fas fa-list"></i> Detalles de la Factura (${factura.detalles.length} items)
                    </h4>
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Código</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Descripción</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Cantidad</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Precio Unit.</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Descuento</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                factura.detalles.forEach((detalle, index) => {
                    const rowColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    html += `
                        <tr style="background: ${rowColor};">
                            <td style="padding: 6px; border: 1px solid #ddd; font-size: 11px;">${detalle.codigoPrincipal}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; font-size: 11px;">${detalle.descripcion}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${detalle.cantidad}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-size: 11px;">$${detalle.precioUnitario}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-size: 11px;">$${detalle.descuento}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-size: 11px; font-weight: bold;">$${detalle.precioTotalSinImpuesto}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <i class="fas fa-exclamation-triangle" style="color: #856404; margin-right: 8px;"></i>
                        <strong>Nota:</strong> No se encontraron detalles de la factura en el XML.
                    </div>
                `;
            }
            
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        
        // Escapar HTML para mostrar XML de forma segura
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Cerrar modal
        function closeModal() {
            const modal = document.getElementById('factura-modal');
            modal.classList.remove('active');
            selectedFile = null;
            facturaData = null;
            document.getElementById('file-input').value = '';
        }
        
        // Confirmar registro de factura
        function confirmarRegistro() {
            if (!selectedFile || !facturaData) {
                alert('No hay archivo seleccionado');
                return;
            }
            
            const formData = new FormData();
            formData.append('archivo_xml', selectedFile);
            formData.append('datos_factura', JSON.stringify(facturaData));
            
            // Mostrar indicador de carga
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;"></i>
                    <p>Registrando factura...</p>
                </div>
            `;
            
            fetch('api/upload_factura_individual.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 15px;"></i>
                            <h3 style="color: #28a745;">¡Factura Registrada Exitosamente!</h3>
                            <p>La factura ha sido registrada en el sistema.</p>
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                <strong>Clave de Acceso:</strong> ${data.data.clave_acceso}<br>
                                <strong>Cliente:</strong> ${data.data.cliente}<br>
                                <strong>Total:</strong> $${data.data.total}
                            </div>
                        </div>
                    `;
                    
                    // Recargar la tabla de facturas después de 3 segundos
                    setTimeout(() => {
                        closeModal();
                        loadFacturasList();
                    }, 3000);
                } else {
                    // Determinar el tipo de error para mostrar el icono apropiado
                    let iconClass = 'fas fa-exclamation-triangle';
                    let iconColor = '#dc3545';
                    let titleColor = '#dc3545';
                    
                    if (data.message.includes('ya está registrada') || data.message.includes('ya existe')) {
                        iconClass = 'fas fa-info-circle';
                        iconColor = '#ffc107';
                        titleColor = '#ffc107';
                    }
                    
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="${iconClass}" style="font-size: 3rem; color: ${iconColor}; margin-bottom: 15px;"></i>
                            <h3 style="color: ${titleColor};">
                                ${data.message.includes('ya está registrada') ? 'Factura Ya Registrada' : 'Error al Registrar'}
                            </h3>
                            <p style="color: var(--text-secondary);">${data.message}</p>
                            ${data.message.includes('ya está registrada') ? `
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                    <strong>Información:</strong><br>
                                    • Esta factura ya existe en el sistema<br>
                                    • No se puede registrar la misma factura dos veces<br>
                                    • Verifica que no hayas subido este archivo anteriormente
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Si es un error de duplicado, cerrar el modal después de 5 segundos
                    if (data.message.includes('ya está registrada')) {
                        setTimeout(() => {
                            closeModal();
                        }, 5000);
                    }
                }
            })
            .catch(error => {
                console.error('Error registrando factura:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 15px;"></i>
                        <h3 style="color: #dc3545;">Error de Conexión</h3>
                        <p>Error al conectar con el servidor. Verifica tu conexión a internet.</p>
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin-top: 15px;">
                            <strong>Detalles del error:</strong><br>
                            ${error.message || 'Error desconocido'}
                        </div>
                    </div>
                `;
            });
        }
        
        // Cargar datos del dashboard
        function loadDashboardData() {
            // Cargar estadísticas
            fetch('api/dashboard_stats.php', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('total-facturas').textContent = data.data.facturacion.total;
                    document.getElementById('total-facturado').textContent = '$' + parseFloat(data.data.facturacion.total_facturado_mes || 0).toFixed(2);
                    document.getElementById('facturas-hoy').textContent = data.data.facturacion.hoy;
                    document.getElementById('clientes-unicos').textContent = data.data.clientes.total;
                }
            })
            .catch(error => {
                console.error('Error cargando estadísticas:', error);
            });
            
            // Cargar actividad reciente
            loadRecentActivity();
        }
        
        // Cargar actividad reciente
        function loadRecentActivity() {
            fetch('api/recent_activity.php', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRecentActivity(data.data);
                }
            })
            .catch(error => {
                console.error('Error cargando actividad:', error);
            });
        }
        
        // Mostrar actividad reciente
        function displayRecentActivity(activities) {
            const container = document.getElementById('recent-activity');
            
            if (activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay actividad reciente</p>';
                return;
            }
            
            let html = '';
            activities.forEach(activity => {
                html += `
                    <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--glass-border);">
                        <div style="width: 40px; height: 40px; background: ${getActivityColor(activity.color)}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                            <i class="${activity.icono}" style="color: white; font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">${activity.descripcion}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${activity.tiempo}</div>
                        </div>
                        ${activity.monto ? `<div style="font-weight: 600; color: var(--primary-color);">${activity.monto}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Obtener color de actividad
        function getActivityColor(color) {
            const colors = {
                'success': '#28a745',
                'info': '#17a2b8',
                'warning': '#ffc107',
                'danger': '#dc3545'
            };
            return colors[color] || '#6c757d';
        }
        
        // Cargar lista de facturas
        function loadFacturasList() {
            const container = document.getElementById('facturas-table-container');
            
            if (!container) {
                console.error('No se encontró el contenedor facturas-table-container');
                return;
            }
            
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Cargando facturas...</p></div>';
            
            fetch('api/get_facturas_simple.php', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFacturasTable(data.data);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                            <h3>Error al cargar facturas</h3>
                            <p>${data.message || 'Error desconocido'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error cargando facturas:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3>Error de Conexión</h3>
                        <p>Error al conectar con el servidor. Verifica tu conexión a internet.</p>
                    </div>
                `;
            });
        }
        
        // Mostrar tabla de facturas
        function displayFacturasTable(facturas) {
            const container = document.getElementById('facturas-table-container');
            
            if (!container) {
                console.error('No se encontró el contenedor facturas-table-container');
                return;
            }
            
            if (!Array.isArray(facturas)) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3>Error en el formato de datos</h3>
                        <p>Los datos recibidos no tienen el formato esperado</p>
                    </div>
                `;
                return;
            }
            
            if (facturas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file-invoice" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                        <h3>No hay facturas registradas</h3>
                        <p>Sube facturas individuales para verlas aquí</p>
                        <div style="background: #e7f3ff; border: 1px solid #b3d9ff; padding: 15px; border-radius: 5px; margin-top: 15px;">
                            <strong>💡 Consejo:</strong> Haz clic en "Buscar Archivo XML" para subir tu primera factura.
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="facturas-table">
                    <thead>
                        <tr>
                            <th>ESTAB</th>
                            <th>PTO EMI</th>
                            <th>SECUENCIAL</th>
                            <th>FECHA CREACIÓN</th>
                            <th>CLIENTE</th>
                            <th>DIRECCIÓN</th>
                            <th>TOTAL</th>
                            <th>ESTATUS</th>
                            <th>RETENCIÓN</th>
                            <th>VALOR PAGADO</th>
                            <th>OBSERVACIÓN</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            facturas.forEach(factura => {
                html += `
                    <tr>
                        <td>${factura.estab || 'N/A'}</td>
                        <td>${factura.pto_emi || 'N/A'}</td>
                        <td>${factura.secuencial || 'N/A'}</td>
                        <td>${factura.fecha_creacion || 'N/A'}</td>
                        <td>${factura.cliente || 'N/A'}</td>
                        <td>${factura.direccion || 'N/A'}</td>
                        <td>$${factura.total || '0.00'}</td>
                        <td style="color: ${factura.estatus === 'REGISTRADA' ? '#28a745' : '#dc3545'};">${factura.estatus || 'PENDIENTE'}</td>
                        <td>$${factura.retencion || '0.00'}</td>
                        <td>$${factura.valor_pagado || '0.00'}</td>
                        <td>${factura.observacion || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Funciones para los botones
        function downloadFacturas() {
            alert('Función de descarga de facturas en desarrollo');
        }
        
        function nuevaFactura() {
            alert('Función de nueva factura en desarrollo');
        }
        
        function generarReporte() {
            alert('Función de reportes en desarrollo');
        }
    </script>
    
    <!-- Modal para preview de facturas -->
    <div id="factura-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-invoice"></i> Preview de Factura
                </h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modal-content">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-confirm" onclick="confirmarRegistro()">
                    <i class="fas fa-check"></i> Sí, Registrar Factura
                </button>
            </div>
        </div>
    </div>
    
    <style>
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-filter);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .factura-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .factura-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background: rgba(74, 222, 128, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }
        
        .info-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--glass-border);
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        .btn-confirm {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-confirm:hover {
            background: #28a745;
        }
        
        .file-input-hidden {
            display: none;
        }
    </style>
</body>
</html> 